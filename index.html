<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global News Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #333;
            /* Added padding-top to compensate for fixed header */
            padding-top: 6rem; /* Adjust this value if header height changes on mobile */
        }
        @media (min-width: 768px) { /* Adjust for md screens if header height changes */
            body {
                padding-top: 5rem; /* Adjust for desktop header height */
            }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Hide default number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Toast Message Styles */
        #messageBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through when hidden */
        }
        #messageBox.show {
            opacity: 1;
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Blue-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Featured Message Styles */
        #featuredMessageContainer {
            overflow: hidden; /* Hide overflowing text during transition */
            height: 40px; /* Fixed height to prevent layout shifts */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #e0f2fe; /* Light blue background */
            color: #1e40af; /* Darker blue text */
            font-weight: 600;
            margin-top: 1rem; /* Space below header */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 0.5rem 1rem;
        }
        #featuredMessage {
            position: absolute;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(100%); /* Start from bottom */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        #featuredMessage.show {
            opacity: 1;
            transform: translateY(0);
        }
        #featuredMessage.hide {
            opacity: 0;
            transform: translateY(-100%); /* Exit to top */
        }

        /* Search Highlight Animation */
        @keyframes pulseRing {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); /* yellow-400 with opacity */
            }
            70% {
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        .animate-pulse {
            animation: pulseRing 1.5s infinite;
        }

        /* Mobile Menu specific styles */
        #mobileMenu {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%); /* Start off-screen right */
            backdrop-filter: blur(5px); /* Optional: for a frosted glass effect */
            -webkit-backdrop-filter: blur(5px); /* For Safari */
        }
        #mobileMenu.show { /* Use .show class to trigger animation */
            opacity: 1;
            transform: translateX(0); /* Slide in */
        }
        #mobileMenu.hidden { /* When hidden */
            opacity: 0;
            transform: translateX(100%); /* Slide out */
        }

        /* Desktop Categories Dropdown styles */
        #desktopCategoriesDropdown {
            transform-origin: top;
            transform: scaleY(0); /* Start hidden */
            transition: transform 0.2s ease-out, opacity 0.2s ease-out, visibility 0.2s ease-out;
            opacity: 0;
            visibility: hidden;
        }
        .group:hover #desktopCategoriesDropdown {
            transform: scaleY(1); /* Expand on hover */
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-purple-700 text-white p-4 shadow-lg rounded-b-xl z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-newspaper text-3xl md:text-4xl text-yellow-300"></i> <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Global News Hub</h1>
            </div>

            <nav class="hidden md:flex items-center space-x-6 text-lg font-medium">
                <a href="#" class="text-white hover:text-blue-200 transition duration-300">Home</a>

                <div class="relative group">
                    <button id="desktopCategoriesDropdownBtn" class="text-white hover:text-blue-200 transition duration-300 flex items-center">
                        Categories <i class="fas fa-chevron-down ml-2 text-xs group-hover:rotate-180 transition-transform"></i>
                    </button>
                    <div id="desktopCategoriesDropdown" class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                        </div>
                </div>

                <a href="#" class="text-white hover:text-blue-200 transition duration-300">Chat</a>
                <a href="#" class="text-white hover:text-blue-200 transition duration-300">Marketplace</a>
                <button id="searchIconDesktop" class="text-yellow-300 hover:text-blue-200 transition duration-300">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <a href="https://wa.me/2349110497676?text=I%20have%20information%20about%20certain%20matters%20and%20I%20would%20like%20to%20share%20them%2C%20please."
                   target="_blank" rel="noopener noreferrer"
                   class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-full shadow-md hover:bg-yellow-500 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75 flex items-center space-x-2">
                    <i class="fab fa-whatsapp"></i>
                    <span>Snitch</span>
                </a>
                <button id="adminLoginBtnDesktop" class="bg-white text-blue-600 px-4 py-2 rounded-full shadow-md hover:bg-blue-50 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75">
                    Admin Login
                </button>
            </nav>

            <div class="md:hidden flex items-center space-x-4">
                <button id="searchIconMobile" class="text-yellow-300 hover:text-blue-200 transition duration-300">
                    <i class="fas fa-search text-xl"></i>
                </button>
                <button id="menuButton" class="text-white focus:outline-none">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="mobileMenu" class="hidden md:hidden fixed inset-0 bg-blue-700 bg-opacity-95 z-40 flex flex-col items-center justify-center space-y-8">
            <button id="closeMenuButton" class="absolute top-4 right-4 text-white text-3xl focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
            <nav class="flex flex-col space-y-6 text-2xl font-semibold w-full px-8">
                <a href="#" class="text-white hover:text-blue-200 transition duration-300 text-center py-3">Home</a>

                <div class="relative w-full">
                    <button id="mobileCategoriesDropdownBtn" class="w-full text-center text-white hover:text-blue-200 transition duration-300 py-3 flex items-center justify-center">
                        Categories <i class="fas fa-chevron-down ml-2 text-xl"></i>
                    </button>
                    <div id="mobileCategoriesDropdown" class="mt-2 bg-blue-800 rounded-md shadow-lg py-1 z-20 hidden">
                        </div>
                </div>

                <a href="#" class="text-white hover:text-blue-200 transition duration-300 text-center py-3">Chat</a>
                <a href="#" class="text-white hover:text-blue-200 transition duration-300 text-center py-3">Marketplace</a>
                <a href="https://wa.me/2349110497676?text=I%20have%20information%20about%20certain%20matters%20and%20I%20would%20like%20to%20share%20them%2C%20please."
                   target="_blank" rel="noopener noreferrer"
                   class="bg-yellow-400 text-gray-900 px-6 py-3 rounded-full shadow-md hover:bg-yellow-500 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75 flex items-center justify-center space-x-2 w-full">
                    <i class="fab fa-whatsapp text-xl"></i>
                    <span class="text-xl">Snitch Line</span>
                </a>
                <button id="adminLoginBtnMobile" class="text-white hover:text-blue-200 transition duration-300 text-center py-3">Admin Login</button>
            </nav>
        </div>

        <div id="searchOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 relative">
                <button id="closeSearchButton" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl focus:outline-none">
                    <i class="fas fa-times"></i>
                </button>
                <h3 class="text-2xl font-bold mb-4 text-gray-900">Search News</h3>
                <div class="flex">
                    <input type="text" id="searchInput" placeholder="Search articles or comments..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 placeholder-gray-500 text-gray-800">
                    <button id="performSearchButton" class="bg-blue-600 text-white px-5 py-3 rounded-r-lg hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="searchResults" class="mt-4 max-h-60 overflow-y-auto border-t border-gray-200 pt-4 hidden">
                </div>
                <p id="noSearchResults" class="text-gray-500 text-center mt-4 hidden">No results found.</p>
            </div>
        </div>
    </header>

    <div id="featuredMessageContainer" class="container mx-auto max-w-lg md:max-w-3xl lg:max-w-4xl">
        <span id="featuredMessage" class="px-2 py-1 rounded-md bg-blue-100 text-blue-800 text-sm font-semibold">Featured: Welcome to Global News Hub!</span>
    </div>

    <main class="container mx-auto my-8 p-4 flex-grow max-w-lg md:max-w-3xl lg:max-w-4xl">
        <section id="adminPanel" class="hidden bg-white p-8 mb-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800 border-b pb-3">Admin Dashboard</h2>

            <div id="adminLoginSection">
                <p class="text-lg mb-4 text-gray-600">Enter admin password to access content upload:</p>
                <div class="flex items-center space-x-4">
                    <input type="password" id="adminPassword" placeholder="Admin Password" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    <button id="passwordSubmitBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                        Submit
                    </button>
                </div>
                <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Incorrect password. Please try again.</p>
            </div>

            <div id="newsUploadFormContainer" class="hidden">
                <h3 class="text-2xl font-medium mb-4 text-gray-700">Upload New Article</h3>
                <form id="newsForm" class="space-y-6">
                    <div>
                        <label for="articleTitle" class="block text-gray-700 text-sm font-bold mb-2">Article Title:</label>
                        <input type="text" id="articleTitle" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="Enter article title" required>
                    </div>
                    <div>
                        <label for="articleContent" class="block text-gray-700 text-sm font-bold mb-2">Article Content:</label>
                        <textarea id="articleContent" rows="8" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 resize-y" placeholder="Write your article content here..." required></textarea>
                    </div>

                    <div>
                        <label for="articleCategories" class="block text-gray-700 text-sm font-bold mb-2">Categories (Select one or more):</label>
                        <select id="articleCategories" multiple class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 h-32">
                            <option value="General" selected>General</option>
                            <option value="Politics">Politics</option>
                            <option value="Technology">Technology</option>
                            <option value="Sports">Sports</option>
                            <option value="World">World News</option>
                            <option value="Health">Health</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Business">Business</option>
                            <option value="Science">Science</option>
                            <option value="Environment">Environment</option>
                        </select>
                    </div>
                    <div>
                        <label for="articleImage" class="block text-gray-700 text-sm font-bold mb-2">Image Upload (Optional):</label>
                        <input type="file" id="articleImage" accept="image/*" class="shadow-sm appearance-none border border-gray-300 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>
                    <button type="submit" class="bg-green-600 text-white px-8 py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                        Publish Article
                    </button>
                </form>
                <button id="adminLogoutBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-red-600 transition duration-300 ease-in-out mt-6 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                    Logout
                </button>
            </div>
        </section>

        <section id="singleArticleView" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
            <button id="backToNewsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full inline-flex items-center mb-6 transition duration-200 ease-in-out transform hover:scale-105">
                <i class="fas fa-arrow-left mr-2"></i> Back to News
            </button>
            <div id="articleDetailContent">
                </div>
        </section>

        <section id="newsFeedSection" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800 border-b pb-3">Latest News</h2>
            <div id="loadingIndicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner"></div>
                <p class="ml-4 text-gray-600">Loading articles...</p>
            </div>
            <div id="newsArticlesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <p id="noNewsMessage" class="col-span-full text-center text-gray-500 text-lg">No news articles published yet. Stay tuned!</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white p-6 mt-8 rounded-t-xl shadow-lg">
        <div class="container mx-auto text-center text-gray-400">
            &copy; 2025 Global News Hub. All rights reserved.
        </div>
    </footer>

    <div id="messageBox" class="hidden"></div>

    <script>
        // --- Global Variables ---
let ws;
const WEBSOCKET_SERVER_URL = 'https://newsapp-z14a.onrender.com';
let newsArticles = []; // Stores articles with their comments and reactions


const ADMIN_PASSWORD_ENCODED = 'UHJlc3MxMjM0';
const ADMIN_PASSWORD = atob(ADMIN_PASSWORD_ENCODED); 

let isAdminLoggedIn = false;
// Simple client ID for comments/reactions. In a real app, this would be a user ID.
const CLIENT_ID = 'user_' + Math.random().toString(36).substring(2, 9);

// Rotating messages for the footer
const rotatingFooterMessages = [
    "New features are dropping soon!",
    "Thank you for joining us!",
    "Stay informed with Global News Hub.",
    "Your daily dose of reliable news.",
    "We value your feedback!",
    "contact us @09110497676 whatsapp"
];
let currentFooterMessageIndex = 0;
let footerMessageInterval; // To store the interval ID

// Rotating messages for the featured section at the top
const featuredMessages = [
    "Welcome to Global News Hub!",
    "Breaking news, delivered instantly.",
    "Your trusted source for global updates.",
    "Explore diverse perspectives.",
    "Stay curious, stay informed."
];
let currentFeaturedMessageIndex = 0;
let featuredMessageInterval;

// All possible categories, including "All" for filtering
const ALL_CATEGORIES = ["All", "General", "Politics", "Technology", "Sports", "World", "Health", "Entertainment", "Business", "Science", "Environment"];


// --- DOM Elements ---
const adminLoginBtnDesktop = document.getElementById('adminLoginBtnDesktop');
const adminLoginBtnMobile = document.getElementById('adminLoginBtnMobile');
const adminPanel = document.getElementById('adminPanel');
const adminLoginSection = document.getElementById('adminLoginSection');
const adminPasswordInput = document.getElementById('adminPassword');
const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
const passwordError = document.getElementById('passwordError');
const newsUploadFormContainer = document.getElementById('newsUploadFormContainer');
const newsForm = document.getElementById('newsForm');
const articleTitleInput = document.getElementById('articleTitle');
const articleContentInput = document.getElementById('articleContent');
const articleImageInput = document.getElementById('articleImage');
const articleCategoriesInput = document.getElementById('articleCategories'); // New category input
const newsArticlesContainer = document.getElementById('newsArticlesContainer');
const noNewsMessage = document.getElementById('noNewsMessage');
const adminLogoutBtn = document.getElementById('adminLogoutBtn');
const messageBox = document.getElementById('messageBox');
const loadingIndicator = document.getElementById('loadingIndicator');
const footerText = document.querySelector('footer div');
const featuredMessageElement = document.getElementById('featuredMessage');

// Header Elements
const menuButton = document.getElementById('menuButton');
const mobileMenu = document.getElementById('mobileMenu');
const closeMenuButton = document.getElementById('closeMenuButton');
const searchIconDesktop = document.getElementById('searchIconDesktop');
const searchIconMobile = document.getElementById('searchIconMobile');
const searchOverlay = document.getElementById('searchOverlay');
const closeSearchButton = document.getElementById('closeSearchButton');
const searchInput = document.getElementById('searchInput');
const performSearchButton = document.getElementById('performSearchButton');
const searchResultsContainer = document.getElementById('searchResults');
const noSearchResultsMessage = document.getElementById('noSearchResults');

// New DOM elements for single article view
const singleArticleView = document.getElementById('singleArticleView');
const articleDetailContent = document.getElementById('articleDetailContent');
const backToNewsBtn = document.getElementById('backToNewsBtn');
const newsFeedSection = document.getElementById('newsFeedSection'); // Your existing main section

// New DOM elements for categories dropdowns
const desktopCategoriesDropdownBtn = document.getElementById('desktopCategoriesDropdownBtn');
const desktopCategoriesDropdown = document.getElementById('desktopCategoriesDropdown');
const mobileCategoriesDropdownBtn = document.getElementById('mobileCategoriesDropdownBtn');
const mobileCategoriesDropdown = document.getElementById('mobileCategoriesDropdown');


// --- Helper Functions ---

/**
 * Displays a temporary message box (toast notification).
 * @param {string} message - The message to display.
 * @param {string} type - 'success' or 'error' for styling (optional).
 */
function showMessage(message, type = 'info') {
    messageBox.textContent = message;
    messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'bg-gray-800');
    if (type === 'success') {
        messageBox.classList.add('bg-green-500');
    } else if (type === 'error') {
        messageBox.classList.add('bg-red-500');
    } else {
        messageBox.classList.add('bg-gray-800');
    }
    messageBox.classList.add('show');

    setTimeout(() => {
        messageBox.classList.remove('show');
        setTimeout(() => messageBox.classList.add('hidden'), 300); // Hide after transition
    }, 3000); // Message visible for 3 seconds
}

/**
 * Rotates the messages in the footer.
 */
function startRotatingFooterMessages() {
    // Initial display
    footerText.textContent = rotatingFooterMessages[currentFooterMessageIndex];

    // Set interval for rotation
    footerMessageInterval = setInterval(() => {
        currentFooterMessageIndex = (currentFooterMessageIndex + 1) % rotatingFooterMessages.length;
        footerText.textContent = rotatingFooterMessages[currentFooterMessageIndex];
    }, 30000); // Every 30 seconds
}

/**
 * Rotates the featured messages at the top of the screen with a swipe effect.
 */
function startFeaturedMessages() {
    const displayNextMessage = () => {
        featuredMessageElement.classList.remove('show');
        featuredMessageElement.classList.add('hide');

        setTimeout(() => {
            currentFeaturedMessageIndex = (currentFeaturedMessageIndex + 1) % featuredMessages.length;
            featuredMessageElement.textContent = `Featured: ${featuredMessages[currentFeaturedMessageIndex]}`;
            featuredMessageElement.classList.remove('hide');
            featuredMessageElement.classList.add('show');
        }, 500); // Wait for hide transition to finish before showing next
    };

    // Initial display
    featuredMessageElement.textContent = `Featured: ${featuredMessages[currentFeaturedMessageIndex]}`;
    featuredMessageElement.classList.add('show');

    featuredMessageInterval = setInterval(displayNextMessage, 3000); // Change every 3 seconds
}

// --- Header Interaction Functions ---

function showMobileMenu() {
    mobileMenu.classList.remove('hidden');
    // Force reflow to ensure transition works
    mobileMenu.offsetWidth;
    mobileMenu.classList.add('show'); // Use .show class for animation
    document.body.style.overflow = 'hidden'; // Prevent scrolling body when menu is open
}

function hideMobileMenu() {
    mobileMenu.classList.remove('show'); // Remove .show to trigger animation back
    setTimeout(() => {
        mobileMenu.classList.add('hidden');
    }, 300); // Wait for transition to finish
    document.body.style.overflow = ''; // Restore body scrolling
    mobileCategoriesDropdown.classList.add('hidden'); // Hide mobile categories dropdown when menu closes
}

function showSearchOverlay() {
    searchOverlay.classList.remove('hidden');
    setTimeout(() => {
        searchOverlay.classList.add('opacity-100');
        searchInput.focus(); // Focus on the input field
    }, 10);
    document.body.style.overflow = 'hidden';
}

function hideSearchOverlay() {
    searchOverlay.classList.remove('opacity-100');
    setTimeout(() => {
        searchOverlay.classList.add('hidden');
        searchInput.value = ''; // Clear search input
        searchResultsContainer.innerHTML = ''; // Clear results
        searchResultsContainer.classList.add('hidden');
        noSearchResultsMessage.classList.add('hidden');
    }, 300);
    document.body.style.overflow = '';
}

function performSearch() {
    const query = searchInput.value.toLowerCase().trim();
    searchResultsContainer.innerHTML = '';
    searchResultsContainer.classList.add('hidden');
    noSearchResultsMessage.classList.add('hidden');

    if (query.length < 2) {
        showMessage('Please enter at least 2 characters to search.', 'info');
        return;
    }

    const filteredArticles = newsArticles.filter(article =>
        article.title.toLowerCase().includes(query) ||
        article.content.toLowerCase().includes(query) ||
        (article.comments && article.comments.some(comment =>
            comment.commentText.toLowerCase().includes(query) ||
            (comment.userName && comment.userName.toLowerCase().includes(query))
        ))
    );

    if (filteredArticles.length > 0) {
        searchResultsContainer.classList.remove('hidden');
        filteredArticles.forEach(article => {
            const div = document.createElement('div');
            div.className = 'p-3 border-b border-gray-100 last:border-b-0 cursor-pointer hover:bg-gray-50';
            div.innerHTML = `<h4 class="font-semibold text-blue-700">${article.title}</h4><p class="text-sm text-gray-600">${article.content.substring(0, 100)}...</p>`;
            div.addEventListener('click', () => {
                window.location.hash = `article-${article.id}`; // Navigate to full article
                hideSearchOverlay();
            });
            searchResultsContainer.appendChild(div);
        });
    } else {
        noSearchResultsMessage.classList.remove('hidden');
    }
}


/**
 * Renders a single news article card for the main feed view.
 * This card is clickable to open the full article.
 * @param {object} article - The news article object.
 * @returns {string} - HTML string for the news article card.
 */
function renderNewsArticle(article) {
    // Display categories for the card view
    const categoriesHtml = (article.categories && article.categories.length > 0)
        ? article.categories.map(cat => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-1 px-2.5 py-0.5 rounded-full">${cat}</span>`).join('')
        : '';

    return `
        <div class="bg-gray-50 p-6 rounded-xl shadow-md border border-gray-100 flex flex-col h-full transform transition duration-300 hover:scale-102 hover:shadow-lg cursor-pointer"
             data-article-id="${article.id}">
            ${article.imageUrl ? `<img src="${article.imageUrl}" alt="${article.title}" class="w-full h-48 object-cover rounded-lg mb-4 shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E0E0E0/666666?text=Image+Not+Found';">` : ''}
            <h3 class="text-xl font-semibold text-gray-800 mb-2">${article.title}</h3>
            <p class="text-gray-600 text-sm flex-grow mb-4">${article.content.substring(0, 250)}...</p>
            <div class="flex flex-wrap gap-1 mb-2">${categoriesHtml}</div>
            <div class="text-xs text-gray-400 mt-auto">Published: ${new Date(article.timestamp).toLocaleString()}</div>
            </div>
    `;
}

/**
 * Populates the category dropdowns dynamically.
 */
function populateCategoriesDropdowns() {
    // Desktop Dropdown
    desktopCategoriesDropdown.innerHTML = '';
    ALL_CATEGORIES.forEach(category => {
        const link = document.createElement('a');
        link.href = `#category-${encodeURIComponent(category)}`; // Use hash for category filtering
        link.className = 'block px-4 py-2 text-gray-800 hover:bg-blue-50 hover:text-blue-600';
        link.textContent = category;
        link.addEventListener('click', (e) => {
            e.preventDefault();
            filterArticlesByCategory(category);
            // Hide dropdown after selection (handled by group-hover for desktop)
            // If not using group-hover, you'd manually toggle desktopCategoriesDropdown.classList.add('hidden');
            showNewsFeed(); // Ensure news feed is visible
        });
        desktopCategoriesDropdown.appendChild(link);
    });

    // Mobile Dropdown
    mobileCategoriesDropdown.innerHTML = '';
    ALL_CATEGORIES.forEach(category => {
        const link = document.createElement('a');
        link.href = `#category-${encodeURIComponent(category)}`;
        link.className = 'block px-4 py-3 text-white hover:bg-blue-700 text-center';
        link.textContent = category;
        link.addEventListener('click', (e) => {
            e.preventDefault();
            filterArticlesByCategory(category);
            hideMobileMenu(); // Close the main mobile menu
            mobileCategoriesDropdown.classList.add('hidden'); // Hide the sub-dropdown
            showNewsFeed(); // Ensure news feed is visible
        });
        mobileCategoriesDropdown.appendChild(link);
    });
}

/**
 * Filters and displays news articles by category.
 * @param {string} category - The category to filter by ("All" to show all).
 */
function filterArticlesByCategory(category) {
    let filtered = [];
    if (category === "All") {
        filtered = newsArticles; // Show all if "All" is selected
    } else {
        filtered = newsArticles.filter(article =>
            article.categories && article.categories.includes(category)
        );
    }

    // Sort filtered articles by timestamp in descending order
    const sortedFilteredArticles = [...filtered].sort((a, b) => b.timestamp - a.timestamp);

    newsArticlesContainer.innerHTML = sortedFilteredArticles.map(renderNewsArticle).join('');
    if (sortedFilteredArticles.length === 0) {
        noNewsMessage.classList.remove('hidden');
        newsArticlesContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 text-lg">No news articles found in category: ${category}.</p>`;
    } else {
        noNewsMessage.classList.add('hidden');
    }
    // Update the hash so that sharing the URL also shows the filtered category
    window.location.hash = `category-${encodeURIComponent(category)}`;
}


/**
 * Displays a single full article view.
 * @param {number} articleId - The ID of the article to display.
 */
function showSingleArticle(articleId) {
    const article = newsArticles.find(a => a.id === articleId);
    if (!article) {
        showMessage('Article not found!', 'error');
        showNewsFeed(); // Fallback to news feed if article is not found
        return;
    }

    // Hide main news feed, admin panel, show single article view
    newsFeedSection.classList.add('hidden');
    adminPanel.classList.add('hidden');
    singleArticleView.classList.remove('hidden');

    // Populate article detail content
    const commentsHtml = (article.comments || []).map(comment => `
        <div class="bg-gray-100 p-3 rounded-lg mb-2 text-sm">
            <p class="font-semibold text-gray-700">${comment.userName || 'Anonymous'}:</p>
            <p class="text-gray-600">${comment.commentText}</p>
            <span class="text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</span>
        </div>
    `).join('');

    // Calculate reaction counts
    const reactions = article.reactions || [];
    const thumbsUpCount = reactions.filter(r => r.type === 'thumbs_up').length;
    const loveCount = reactions.filter(r => r.type === 'love').length;
    const sadCount = reactions.filter(r => r.type === 'sad').length;

    const reactionsHtml = `
        <div class="flex justify-around items-center py-3 border-t border-gray-200 mt-4">
            <button class="reaction-btn flex items-center space-x-1 text-gray-600 hover:text-blue-500 transition duration-200" data-article-id="${article.id}" data-reaction-type="thumbs_up">
                <i class="fas fa-thumbs-up"></i>
                <span class="reaction-count">${thumbsUpCount}</span>
            </button>
            <button class="reaction-btn flex items-center space-x-1 text-gray-600 hover:text-red-500 transition duration-200" data-article-id="${article.id}" data-reaction-type="love">
                <i class="fas fa-heart"></i>
                <span class="reaction-count">${loveCount}</span>
            </button>
            <button class="reaction-btn flex items-center space-x-1 text-gray-600 hover:text-yellow-500 transition duration-200" data-article-id="${article.id}" data-reaction-type="sad">
                <i class="fas fa-sad-tear"></i>
                <span class="reaction-count">${sadCount}</span>
            </button>
        </div>
    `;
    const savedUserName = localStorage.getItem('userName') || '';

    articleDetailContent.innerHTML = `
        ${article.imageUrl ? `<img src="${article.imageUrl}" alt="${article.title}" class="w-full h-auto max-h-96 object-contain rounded-lg mb-6 shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/800x600/E0E0E0/666666?text=Image+Not+Found';">` : ''}
        <h2 class="text-3xl font-bold text-gray-900 mb-3">${article.title}</h2>
        <div class="text-sm text-gray-500 mb-6">Published: ${new Date(article.timestamp).toLocaleString()}</div>
        <p class="text-gray-700 leading-relaxed mb-8">${article.content}</p>
        ${reactionsHtml}
        <div class="mt-8 border-t border-gray-200 pt-6">
            <h3 class="text-xl font-medium text-gray-800 mb-4">Comments</h3>
            <div class="comments-list space-y-3 max-h-60 overflow-y-auto pr-2">
                ${commentsHtml.length > 0 ? commentsHtml : '<p class="text-gray-500 text-sm">No comments yet.</p>'}
            </div>
            <div class="mt-6 flex flex-col space-y-3">
                <input type="text" class="comment-user-name p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-400" placeholder="Your Name (Optional)" data-article-id="${article.id}" value="${savedUserName}">
                <div class="flex space-x-3">
                    <textarea class="comment-input flex-grow p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-400 resize-y" rows="3" placeholder="Add a comment..." data-article-id="${article.id}"></textarea>
                    <button class="post-comment-btn bg-blue-600 text-white px-6 py-3 rounded-lg text-base hover:bg-blue-700 transition duration-200" data-article-id="${article.id}">
                        Post
                    </button>
                </div>
            </div>
        </div>
    `;
    // Scroll to top of the article view
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Hides single article view and shows news feed.
 */
function showNewsFeed() {
    singleArticleView.classList.add('hidden');
    newsFeedSection.classList.remove('hidden');
    adminPanel.classList.add('hidden'); // Ensure admin panel is hidden when returning to news feed
    window.location.hash = ''; // Clear hash to represent main feed
    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of news feed
    updateNewsDisplay(); // Re-render news feed to ensure "All" articles are shown
}

/**
 * Handles URL hash changes to navigate between views.
 */
function handleHashChange() {
    const hash = window.location.hash.substring(1); // Remove '#'
    if (hash.startsWith('article-')) {
        const articleId = parseInt(hash.replace('article-', ''));
        if (!isNaN(articleId)) {
            showSingleArticle(articleId);
        } else {
            showNewsFeed(); // Invalid article ID in hash, go back to news feed
        }
    } else if (hash.startsWith('category-')) {
        const categoryName = decodeURIComponent(hash.replace('category-', ''));
        filterArticlesByCategory(categoryName);
        newsFeedSection.classList.remove('hidden');
        singleArticleView.classList.add('hidden');
        adminPanel.classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    else {
        // If no hash or unrecognized hash, show the main news feed
        showNewsFeed();
    }
}

/**
 * Updates the display of news articles in the main feed or refreshes the current view.
 */
function updateNewsDisplay() {
    const currentHash = window.location.hash.substring(1);
    if (currentHash.startsWith('category-')) {
        const categoryName = decodeURIComponent(currentHash.replace('category-', ''));
        filterArticlesByCategory(categoryName); // Re-apply filter if data changed
    } else if (currentHash.startsWith('article-')) {
        const articleId = parseInt(currentHash.replace('article-', ''));
        if (newsArticles.some(a => a.id === articleId)) {
            showSingleArticle(articleId); // Re-render if current article data changed
        } else {
            // If the article somehow disappears (e.g., deleted), go back to main feed
            showNewsFeed();
        }
    }
    else {
        // Default display for the main feed (all articles)
        if (newsArticles.length === 0) {
            noNewsMessage.classList.remove('hidden');
            newsArticlesContainer.innerHTML = '';
        } else {
            noNewsMessage.classList.add('hidden');
            const sortedArticles = [...newsArticles].sort((a, b) => b.timestamp - a.timestamp);
            newsArticlesContainer.innerHTML = sortedArticles.map(renderNewsArticle).join('');
        }
    }
}


// --- IndexedDB Utility Functions ---
const DB_NAME = 'NewsHubDB';
const DB_VERSION = 1;
const STORE_NAME = 'articles';

let db;

/**
 * Initializes IndexedDB. Opens the database and creates object store if it doesn't exist.
 * @returns {Promise<IDBDatabase>} A promise that resolves with the database instance.
 */
function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                console.log('IndexedDB object store created:', STORE_NAME);
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log('IndexedDB opened successfully.');
            resolve(db);
        };

        request.onerror = (event) => {
            console.error('IndexedDB error:', event.target.errorCode);
            reject('IndexedDB error: ' + event.target.errorCode);
        };
    });
}

/**
 * Adds or updates an article in IndexedDB.
 * @param {object} article - The article object to store.
 * @returns {Promise<void>} A promise that resolves when the article is stored.
 */
function storeArticle(article) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDB not open.');
            return;
        }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        // IndexedDB expects an ID for 'put' operations, ensure it exists or is added
        const articleToStore = { ...article }; // Clone to avoid modifying original
        if (!articleToStore.id) {
            // If ID isn't set, it means it's a new entry and autoIncrement will handle it
            const request = store.add(articleToStore);
            request.onsuccess = (event) => {
                 article.id = event.target.result; // Update original article with new ID from DB
                 resolve();
            };
            request.onerror = (event) => reject(event.target.error);
        } else {
            const request = store.put(articleToStore);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        }
    });
}

/**
 * Adds or updates multiple articles in IndexedDB.
 * @param {Array<object>} articles - An array of article objects to store.
 * @returns {Promise<void>} A promise that resolves when all articles are stored.
 */
function storeArticles(articles) {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDB not open.');
            return;
        }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);

        articles.forEach(article => {
            // Use put, as articles from server will likely have IDs already
            store.put(article);
        });

        transaction.oncomplete = () => resolve();
        transaction.onerror = (event) => reject(event.target.error);
    });
}

/**
 * Retrieves all articles from IndexedDB.
 * @returns {Promise<Array<object>>} A promise that resolves with an array of articles.
 */
function getAllArticlesFromDB() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDB not open.');
            return;
        }
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.getAll();

        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

/**
 * Clears all articles from IndexedDB. (Useful for testing or specific scenarios)
 * @returns {Promise<void>} A promise that resolves when the store is cleared.
 */
function clearArticlesFromDB() {
    return new Promise((resolve, reject) => {
        if (!db) {
            reject('IndexedDB not open.');
            return;
        }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();

        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}


// --- WebSocket Implementation ---

/**
 * Connects to the WebSocket server and sets up event handlers.
 */
function connectWebSocket() {
    // Only show loading indicator if there are no cached articles already displayed
    if (newsArticles.length === 0) {
        loadingIndicator.classList.remove('hidden');
    }

    ws = new WebSocket(WEBSOCKET_SERVER_URL);

    ws.onopen = async () => {
        console.log('WebSocket connected to server.');
        showMessage('Connected to news server.', 'success');

        // Request all articles from server to ensure up-to-date data
        ws.send(JSON.stringify({ type: 'GET_ALL_ARTICLES' }));
    };

    ws.onmessage = (event) => {
        loadingIndicator.classList.add('hidden'); // Hide loading once any server data arrives
        try {
            const data = JSON.parse(event.data);
            console.log('Received message from WebSocket:', data);

            if (data.type === 'NEW_ARTICLE') {
                newsArticles.push(data.article);
                newsArticles.sort((a, b) => b.timestamp - a.timestamp); // Keep sorted
                populateCategoriesDropdowns(); // Ensure dropdowns are re-populated just in case
                updateNewsDisplay();
                storeArticle(data.article).catch(e => console.error("Failed to store new article in DB:", e));
                showMessage('New article published!', 'success');
            } else if (data.type === 'ALL_ARTICLES') {
                const newArticlesFromServer = data.articles;
                const existingArticleIds = new Set(newsArticles.map(a => a.id));

                newArticlesFromServer.forEach(serverArticle => {
                    if (existingArticleIds.has(serverArticle.id)) {
                        const index = newsArticles.findIndex(a => a.id === serverArticle.id);
                        if (index !== -1) {
                            newsArticles[index] = serverArticle; // Update existing article
                        }
                    } else {
                        newsArticles.push(serverArticle); // Add new article
                    }
                });
                newsArticles.sort((a, b) => b.timestamp - a.timestamp); // Sort after updates

                storeArticles(newArticlesFromServer).catch(e => console.error("Failed to store all articles in DB:", e));
                populateCategoriesDropdowns(); // Ensure dropdowns are re-populated just in case
                updateNewsDisplay(); // Refresh display with all articles/current filter
                showMessage('Articles synchronized with server.', 'info');
            } else if (data.type === 'NEW_COMMENT') {
                console.log('Handling NEW_COMMENT message...');
                const { articleId, comment } = data;
                const article = newsArticles.find(a => a.id === articleId);
                if (article) {
                    if (!article.comments) {
                        article.comments = [];
                    }
                    article.comments.push(comment);
                    updateNewsDisplay(); // Refresh display to show new comment
                    storeArticle(article).catch(e => console.error("Failed to update article with new comment in DB:", e));
                    console.log(`New comment for article ${articleId}: "${comment.commentText}" - UI updated.`);
                } else {
                    console.warn(`Article with ID ${articleId} not found for comment.`);
                }
            } else if (data.type === 'NEW_REACTION') {
                console.log('Handling NEW_REACTION message...');
                const { articleId, reaction } = data;
                const article = newsArticles.find(a => a.id === articleId);
                if (article) {
                    if (!article.reactions) {
                        article.reactions = [];
                    }
                    article.reactions.push(reaction);
                    updateNewsDisplay(); // Refresh display to show new reaction count
                    storeArticle(article).catch(e => console.error("Failed to update article with new reaction in DB:", e));
                    console.log(`New reaction '${reaction.type}' for article ${articleId} - UI updated.`);
                } else {
                    console.warn(`Article with ID ${articleId} not found for reaction.`);
                }
            } else if (data.type === 'ERROR') {
                showMessage(`Server Error: ${data.message}`, 'error');
            }
        } catch (e) {
            console.error('Error parsing WebSocket message:', e);
            showMessage('Error receiving data from server.', 'error');
        }
    };

    ws.onclose = () => {
        console.log('WebSocket disconnected. Attempting to reconnect in 5 seconds...');
        showMessage('Disconnected from server. Reconnecting...', 'error');
        loadingIndicator.classList.remove('hidden'); // Ensure loading is shown during reconnect attempts
        setTimeout(connectWebSocket, 5000);
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        showMessage('WebSocket connection error!', 'error');
    };
}

// --- Event Listeners ---

// Toggle Admin Panel visibility (Desktop button)
adminLoginBtnDesktop.addEventListener('click', () => {
    adminPanel.classList.toggle('hidden');
    if (!adminPanel.classList.contains('hidden')) {
        if (isAdminLoggedIn) {
            adminLoginSection.classList.add('hidden');
            newsUploadFormContainer.classList.remove('hidden');
        } else {
            adminLoginSection.classList.remove('hidden');
            newsUploadFormContainer.classList.add('hidden');
            adminPasswordInput.value = '';
            passwordError.classList.add('hidden');
        }
        // Hide other views when admin panel is shown
        newsFeedSection.classList.add('hidden');
        singleArticleView.classList.add('hidden');
    } else {
        // If admin panel is being hidden, show news feed
        showNewsFeed();
    }
    hideMobileMenu(); // Ensure mobile menu is closed if open
});

// Toggle Admin Panel visibility (Mobile button)
adminLoginBtnMobile.addEventListener('click', () => {
    adminPanel.classList.toggle('hidden');
    if (!adminPanel.classList.contains('hidden')) {
        if (isAdminLoggedIn) {
            adminLoginSection.classList.add('hidden');
            newsUploadFormContainer.classList.remove('hidden');
        } else {
            adminLoginSection.classList.remove('hidden');
            newsUploadFormContainer.classList.add('hidden');
            adminPasswordInput.value = '';
            passwordError.classList.add('hidden');
        }
        // Hide other views when admin panel is shown
        newsFeedSection.classList.add('hidden');
        singleArticleView.classList.add('hidden');
    } else {
        // If admin panel is being hidden, show news feed
        showNewsFeed();
    }
    hideMobileMenu(); // Close mobile menu after clicking admin login
});

// Admin password submission
passwordSubmitBtn.addEventListener('click', () => {
    if (adminPasswordInput.value === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        adminLoginSection.classList.add('hidden');
        newsUploadFormContainer.classList.remove('hidden');
        passwordError.classList.add('hidden');
        adminLoginBtnDesktop.textContent = 'Admin Logged In';
        adminLoginBtnDesktop.classList.remove('bg-white', 'text-blue-600');
        adminLoginBtnDesktop.classList.add('bg-green-600', 'text-white');
        adminLoginBtnMobile.textContent = 'Admin Logged In';
        showMessage('Admin logged in successfully!', 'success');
    } else {
        passwordError.classList.remove('hidden');
        showMessage('Incorrect password.', 'error');
    }
});

// Admin Logout
adminLogoutBtn.addEventListener('click', () => {
    isAdminLoggedIn = false;
    adminPanel.classList.add('hidden');
    adminLoginBtnDesktop.textContent = 'Admin Login';
    adminLoginBtnDesktop.classList.remove('bg-green-600', 'text-white');
    adminLoginBtnDesktop.classList.add('bg-white', 'text-blue-600');
    adminLoginBtnMobile.textContent = 'Admin Login';
    showMessage('Admin logged out.', 'info');
    showNewsFeed(); // Return to news feed after logout
});

// News article submission
newsForm.addEventListener('submit', (e) => {
    e.preventDefault();

    if (!isAdminLoggedIn) {
        showMessage('You must be logged in as an admin to publish news.', 'error');
        return;
    }

    const title = articleTitleInput.value;
    const content = articleContentInput.value;
    const imageFile = articleImageInput.files[0];
    const selectedCategories = Array.from(articleCategoriesInput.selectedOptions).map(option => option.value);

    if (!title || !content) {
        showMessage('Please fill in both title and content.', 'info');
        return;
    }
    if (selectedCategories.length === 0) {
        showMessage('Please select at least one category for the article.', 'info');
        return;
    }

    if (imageFile) {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64Image = reader.result;
            const newArticle = {
                title: title,
                content: content,
                imageUrl: base64Image,
                timestamp: Date.now(),
                categories: selectedCategories
            };
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'PUBLISH_ARTICLE', article: newArticle }));
                newsForm.reset();
                showMessage('Article sent for publishing (with image)!', 'success');
            } else {
                showMessage('WebSocket is not connected. Cannot publish article.', 'error');
            }
        };
        reader.onerror = (error) => {
            console.error('FileReader error:', error);
            showMessage('Error reading image file.', 'error');
        };
        reader.readAsDataURL(imageFile);
    } else {
        const newArticle = {
            title: title,
            content: content,
            imageUrl: '',
            timestamp: Date.now(),
            categories: selectedCategories
        };
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'PUBLISH_ARTICLE', article: newArticle }));
            newsForm.reset();
            showMessage('Article sent for publishing (no image).', 'success');
        } else {
            showMessage('WebSocket is not connected. Cannot publish article.', 'error');
        }
    }
});

// Event delegation for clicking on article cards in the main news feed
newsArticlesContainer.addEventListener('click', (e) => {
    const articleCard = e.target.closest('[data-article-id]');
    if (articleCard) {
        const articleId = parseInt(articleCard.dataset.articleId);
        if (!isNaN(articleId)) {
            window.location.hash = `article-${articleId}`; // Use hash for navigation
            // handleHashChange listener will pick this up and call showSingleArticle
        }
    }
});

// Event delegation for reaction and comment buttons/inputs within the SINGLE ARTICLE VIEW
singleArticleView.addEventListener('click', (e) => {
    // Handle reaction buttons
    const reactionButton = e.target.closest('.reaction-btn');
    if (reactionButton) {
        const articleId = parseInt(reactionButton.dataset.articleId);
        // FIX: Corrected dataset property access from data-reaction-type to reactionType
        const reactionType = reactionButton.dataset.reactionType;
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'POST_REACTION',
                articleId: articleId,
                reaction: {
                    type: reactionType, // This 'type' refers to the reactionType variable
                    clientId: CLIENT_ID,
                    timestamp: Date.now()
                }
            }));
            console.log(`Reaction '${reactionType}' sent for article ${articleId}`);
        } else {
            showMessage('WebSocket not connected. Cannot post reaction.', 'error');
        }
        return;
    }

    // Handle post comment buttons
    const postCommentButton = e.target.closest('.post-comment-btn');
    if (postCommentButton) {
        const articleId = parseInt(postCommentButton.dataset.articleId);
        const commentInput = singleArticleView.querySelector(`.comment-input[data-article-id="${articleId}"]`);
        const userNameInput = singleArticleView.querySelector(`.comment-user-name[data-article-id="${articleId}"]`);

        const commentText = commentInput.value.trim();
        const userName = userNameInput.value.trim() || 'Anonymous';

        if (commentText && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'POST_COMMENT',
                articleId: articleId,
                comment: {
                    userName: userName,
                    commentText: commentText,
                    timestamp: Date.now()
                }
            }));
            commentInput.value = '';
            localStorage.setItem('userName', userName);
            console.log(`Comment sent for article ${articleId}: "${commentText}" by ${userName}`);
        } else if (!commentText) {
            showMessage('Comment cannot be empty.', 'info');
        } else {
            showMessage('WebSocket not connected. Cannot post comment.', 'error');
        }
    }
});

// New Event Listeners for Header Menu and Search
menuButton.addEventListener('click', showMobileMenu);
closeMenuButton.addEventListener('click', hideMobileMenu);

searchIconDesktop.addEventListener('click', showSearchOverlay);
searchIconMobile.addEventListener('click', showSearchOverlay);
closeSearchButton.addEventListener('click', hideSearchOverlay);

performSearchButton.addEventListener('click', performSearch);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        performSearch();
    }
});

// Close mobile menu/search overlay if clicked outside
mobileMenu.addEventListener('click', (e) => {
    if (e.target === mobileMenu) {
        hideMobileMenu();
    }
});
searchOverlay.addEventListener('click', (e) => {
    if (e.target === searchOverlay) {
        hideSearchOverlay();
    }
});

// Toggle mobile categories dropdown
mobileCategoriesDropdownBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent closing the main menu
    mobileCategoriesDropdown.classList.toggle('hidden');
});

// Event listener for the back button in single article view
backToNewsBtn.addEventListener('click', showNewsFeed);

// Listen for hash changes to navigate between views
window.addEventListener('hashchange', handleHashChange);


// --- Initial Setup ---
window.onload = async () => {
    // 1. Open IndexedDB first
    await openDatabase();

    // 2. Load articles from IndexedDB immediately
    try {
        const articlesFromDB = await getAllArticlesFromDB();
        if (articlesFromDB.length > 0) {
            newsArticles = articlesFromDB; // Populate global newsArticles array
            updateNewsDisplay(); // Render the cached articles IMMEDIATELY
            showMessage('Articles loaded from cache.', 'info');
        } else {
            // If no articles in IndexedDB, show loading indicator as we'll wait for server
            loadingIndicator.classList.remove('hidden');
        }
    } catch (error) {
        console.error("Error loading from IndexedDB:", error);
        showMessage("Could not load articles from cache.", "error");
        loadingIndicator.classList.remove('hidden'); // Show loading if DB fails
    }

    // 3. Then, initiate WebSocket connection
    connectWebSocket();
    startRotatingFooterMessages();
    startFeaturedMessages();
    populateCategoriesDropdowns(); // Populate dropdowns on load

    // 4. Handle URL hash for initial view (important if a user bookmarked an article/category)
    handleHashChange();

    const savedUserName = localStorage.getItem('userName');
    if (savedUserName) {
        document.querySelectorAll('.comment-user-name').forEach(input => {
            input.value = savedUserName;
        });
    }
};

    </script>
</body>
</html>
